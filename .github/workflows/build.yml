name: "Zig-like-Rust â€” Build + ProofLedger + Auto Release"

on:
  push:
    tags: [ 'v*' ]   # v1.0.0 ê°™ì€ íƒœê·¸ í‘¸ì‹œ ì‹œ ë¦´ë¦¬ì¦ˆ ìë™ ìƒì„±
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: zig-like-rust-release-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: "Build â€” ${{ matrix.os }}"
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ ubuntu-latest, macos-latest, windows-latest ]

    steps:
      # -----------------------------------------
      # Checkout
      # -----------------------------------------
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # -----------------------------------------
      # Install Rust
      # -----------------------------------------
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      # -----------------------------------------
      # Cargo build
      # -----------------------------------------
      - name: Build (release)
        run: cargo build --release

      # -----------------------------------------
      # Run DSL example
      # -----------------------------------------
      - name: Run example.zr
        run: |
          cargo run --release > out-run.txt

      # -----------------------------------------
      # Generate ProofLedger
      # -----------------------------------------
      - name: Generate ProofLedger
        run: |
          echo "Repository: Zig-like-Rust"                                 >  proofledger-${{ matrix.os }}-${{ github.ref_name }}.txt
          echo "Commit: ${{ github.sha }}"                                >> proofledger-${{ matrix.os }}-${{ github.ref_name }}.txt
          echo "OS: ${{ matrix.os }}"                                     >> proofledger-${{ matrix.os }}-${{ github.ref_name }}.txt
          echo "Build Time: $(date)"                                      >> proofledger-${{ matrix.os }}-${{ github.ref_name }}.txt
          echo "Output: out-run.txt"                                      >> proofledger-${{ matrix.os }}-${{ github.ref_name }}.txt

      # -----------------------------------------
      # Upload artifacts (OSë³„)
      # -----------------------------------------
      - name: Upload run output
        uses: actions/upload-artifact@v4
        with:
          name: out-run-${{ matrix.os }}
          path: out-run.txt

      - name: Upload ProofLedger
        uses: actions/upload-artifact@v4
        with:
          name: proofledger-${{ matrix.os }}
          path: proofledger-${{ matrix.os }}-${{ github.ref_name }}.txt

      - name: Upload executable
        uses: actions/upload-artifact@v4
        with:
          name: zig-like-rust-binary-${{ matrix.os }}
          path: |
            target/release/zig_like_rust
            target/release/zig_like_rust.exe
        continue-on-error: true   # íŒŒì¼ ì—†ëŠ” OSì—ì„œëŠ” ë‹¨ìˆœ í†µê³¼

  # ---------------------------------------------------
  # RELEASE JOB â€” tag push ì‹œ ìë™ Release ìƒì„±
  # ---------------------------------------------------
  release:
    name: "Publish Release"
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')  # íƒœê·¸ í‘¸ì‹œì¼ ë•Œë§Œ ì‹¤í–‰

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: release_assets/

      # GitHub Release ìƒì„±
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: "Zig-like-Rust ${{ github.ref_name }}"
          body: |
            ğŸš€ **Zig-like-Rust Release â€” ${{ github.ref_name }}**

            í¬í•¨ëœ í•­ëª©:
            - 3OS ë¹Œë“œ ê²°ê³¼ ë°”ì´ë„ˆë¦¬
            - ProofLedger (OSë³„)
            - example.zr ì‹¤í–‰ ê²°ê³¼(out-run)
            - ìë™ ë¹Œë“œ / ì˜ë¯¸ í•´ì„ ì—”ì§„ ì™„ì„±ë³¸

          files: |
            release_assets/**/*

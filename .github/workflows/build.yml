name: "Zig-like-Rust â€” Build + ProofLedger + Conditional Release"

on:
  push:
    branches: [ main ]
    paths:
      - "src/**"
      - "example.zr"
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: zig-like-rust-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: "Build â€” ${{ matrix.os }}"
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ ubuntu-latest, macos-latest, windows-latest ]

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build project
        run: cargo build --release

      - name: Run example.zr
        run: cargo run --release > out-run.txt

      - name: Generate ProofLedger
        run: |
          echo "Repository: Zig-like-Rust"                                 >  proofledger-${{ matrix.os }}-${{ github.sha }}.txt
          echo "Commit: ${{ github.sha }}"                                >> proofledger-${{ matrix.os }}-${{ github.sha }}.txt
          echo "OS: ${{ matrix.os }}"                                     >> proofledger-${{ matrix.os }}-${{ github.sha }}.txt
          echo "Build Time: $(date)"                                      >> proofledger-${{ matrix.os }}-${{ github.sha }}.txt
          echo "Output: out-run.txt"                                      >> proofledger-${{ matrix.os }}-${{ github.sha }}.txt

      - name: Upload out-run
        uses: actions/upload-artifact@v4
        with:
          name: out-run-${{ matrix.os }}
          path: out-run.txt

      - name: Upload ProofLedger
        uses: actions/upload-artifact@v4
        with:
          name: proofledger-${{ matrix.os }}
          path: proofledger-${{ matrix.os }}-${{ github.sha }}.txt

      - name: Upload Executable
        uses: actions/upload-artifact@v4
        with:
          name: zig-like-rust-binary-${{ matrix.os }}
          path: |
            target/release/zig_like_rust
            target/release/zig_like_rust.exe
        continue-on-error: true

  release:
    name: "Publish Release"
    needs: build
    runs-on: ubuntu-latest

    # ğŸ‘‰ ì¡°ê±´: src ë˜ëŠ” example ë³€ê²½ëœ push ì¼ ë•Œë§Œ ì‹¤í–‰ë¨
    if: github.event_name == 'push'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: release_assets/

      - name: Create Release Tag Name
        id: tag
        run: echo "TAG=v_${{ github.run_number }}" >> $GITHUB_ENV

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.TAG }}
          name: "Zig-like-Rust Release ${{ env.TAG }}"
          body: |
            ğŸ”¥ **Zig-like-Rust ìë™ ë¦´ë¦¬ì¦ˆ â€” ${{ env.TAG }}**
            - src/ ë˜ëŠ” example.zr ë³€ê²½ ê°ì§€ë¨ â†’ ìë™ ë¦´ë¦¬ì¦ˆ ìƒì„±
            - 3OS ë¹Œë“œ ì™„ë£Œ
            - ProofLedger í¬í•¨
            - out-run ê²°ê³¼ í¬í•¨
            - ì‹¤í–‰íŒŒì¼ í¬í•¨
          files: release_assets/**/*
